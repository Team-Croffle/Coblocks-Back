<!DOCTYPE html>
<html lang="ko">
<head>
    <title>Simple Classroom Tester</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: sans-serif; display: flex; gap: 20px; padding: 20px; }
        .panel { border: 1px solid #ccc; padding: 15px; border-radius: 8px; background-color: #fff; }
        h2 { margin-top: 0; }
        button { cursor: pointer; padding: 8px 12px; margin: 5px 0; border-radius: 4px; border: 1px solid #ccc; width: 100%; }
        button:disabled { cursor: not-allowed; background-color: #eee; }
        .primary { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .danger { background-color: #dc3545; color: white; border-color: #dc3545; }
        input { padding: 8px; width: calc(100% - 18px); margin-bottom: 10px; }
        #consoleLog { border: 1px solid #eee; background: #333; color: #eee; height: 400px; overflow-y: auto; padding: 10px; font-size: 13px; white-space: pre-wrap; font-family: monospace; }
        .log-send { color: #ff8df8; }
        .log-receive { color: #8dff8d; }
        .log-info { color: #80c7ff; }
        .log-error { color: #ff8d8d; }
    </style>
</head>
<body>
    <div class="panel">
        <h2>1. ì—°ê²°</h2>
        <input type="text" id="serverUrl" value="http://localhost:3001">
        <button class="primary" onclick="connectAsManager()">ğŸ”‘ ê°œì„¤ìë¡œ ì—°ê²°</button>
        <button onclick="connectAsParticipant()">ğŸ‘¤ ì°¸ì—¬ìë¡œ ì—°ê²°</button>
        <button class="danger" onclick="disconnectSocket()" id="disconnectBtn" disabled>ğŸ”Œ ì—°ê²° ëŠê¸°</button>
        <p id="connectionStatus"><strong>ìƒíƒœ:</strong> ì—°ê²° ì•ˆë¨</p>
    </div>

    <div class="panel">
        <h2>2. ì•¡ì…˜</h2>
        <input type="text" id="roomCodeInput" value="ROOM101">
        <button onclick="createRoom()" id="createBtn" disabled>ğŸ« ê°•ì˜ì‹¤ ìƒì„±</button>
        <button onclick="joinRoom()" id="joinBtn" disabled>ğŸšª ê°•ì˜ì‹¤ ì…ì¥</button>
        <button onclick="leaveRoom()" id="leaveBtn" disabled>ğŸš¶ ê°•ì˜ì‹¤ ë‚˜ê°€ê¸°</button>
    </div>

    <div class="panel" style="width: 500px;">
        <h2>ì½˜ì†” ë¡œê·¸</h2>
        <div id="consoleLog"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // --- ìƒíƒœ ê´€ë¦¬ ë° UI ìš”ì†Œ ---
        let socket = null;
        let currentUser = null;

        const serverUrlInput = document.getElementById("serverUrl");
        const statusP = document.getElementById("connectionStatus");
        const logDiv = document.getElementById("consoleLog");
        const roomCodeInput = document.getElementById("roomCodeInput");
        const allButtons = document.querySelectorAll('button');

        // --- UI í•¨ìˆ˜ ---
        function log(type, message) {
            const logItem = document.createElement('div');
            logItem.className = `log-${type}`;
            logItem.textContent = `[${type.toUpperCase()}] ${new Date().toLocaleTimeString()} - ${message}`;
            logDiv.appendChild(logItem);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateUI() {
            const isConnected = socket && socket.connected;
            statusP.innerHTML = isConnected 
                ? `<strong>ìƒíƒœ:</strong> ì—°ê²°ë¨ (User: ${currentUser.username})`
                : `<strong>ìƒíƒœ:</strong> ì—°ê²° ì•ˆë¨`;
            
            allButtons.forEach(btn => {
                if (btn.id === 'disconnectBtn') {
                    btn.disabled = !isConnected;
                } else if (btn.onclick.toString().includes('connectAs')) {
                    btn.disabled = isConnected;
                } else {
                    btn.disabled = !isConnected;
                }
            });
        }

        // --- í…ŒìŠ¤íŠ¸ìš© ë°ì´í„° ìƒì„± ---
        function createUserData(isManager = false) {
            if (isManager) {
                return { userId: 'manager-uuid-12345', username: 'ë°©ì¥' };
            }
            const randomId = Math.floor(1000 + Math.random() * 9000);
            return { userId: `participant-${randomId}`, username: `ì°¸ì—¬ì-${randomId}` };
        }
        
        // --- ì†Œì¼“ ì—°ê²° ---
        function connectSocket(userData) {
            if (socket) return;
            currentUser = userData;
            
            log('info', `Connecting to ${serverUrlInput.value} as ${currentUser.username}...`);
            socket = io(serverUrlInput.value);

            // --- ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ì—¬ê¸°ì— í•œ ë²ˆë§Œ ë“±ë¡ ---
            socket.on('connect', () => {
                log('info', `Socket connected with ID: ${socket.id}`);
                updateUI();
            });

            socket.on('disconnect', (reason) => {
                log('info', `Socket disconnected. Reason: ${reason}`);
                socket = null;
                currentUser = null;
                updateUI();
            });

            socket.on('error', (error) => log('error', `Socket error: ${JSON.stringify(error)}`));
            socket.on('userJoined', (data) => {
                console.log(data);
                log('receive', `USER_JOINED: ${data.joinUser} ë‹˜ì´ ì…ì¥. ì´ ${data.userCount}ëª…`)
            });
            socket.on('userLeft', (data) => {
                const reason = data.isManagerLeftTemporarily ? '(ë°©ì¥ ì„ì‹œ í‡´ì¥)' : '';
                log('receive', `USER_LEFT: ${data.leftUser} ë‹˜ì´ í‡´ì¥${reason}. ë‚¨ì€ ì¸ì› ${data.userCount}ëª…`);
            });
            socket.on('classroomDeleted', (data) => {
                log('receive', `CLASSROOM_DELETED: ${data.message}`);
                alert(data.message);
                disconnectSocket();
            });
        }
        
        function connectAsManager() { connectSocket(createUserData(true)); }
        function connectAsParticipant() { connectSocket(createUserData(false)); }
        function disconnectSocket() { if (socket) socket.disconnect(); }

        // --- ì•¡ì…˜ í•¨ìˆ˜ ---
        function createRoom() {
            if (!socket || !currentUser) { alert("ë¨¼ì € ì—°ê²°ë¶€í„° í•´ì£¼ì„¸ìš”."); return; }

            const payload = {
                id: `cls-${Date.now()}`, // DB ID ì‹œë®¬ë ˆì´ì…˜
                name: `${currentUser.username}ì˜ ë°©`,
                code: roomCodeInput.value,
                managerId: currentUser.userId,
                managername: currentUser.username
            };
            log('send', `CREATE_ROOM: ${JSON.stringify(payload)}`);
            socket.emit('createRoom', payload, (response) => {
                log('ack', `CREATE_ROOM response: ${JSON.stringify(response)}`);
            });
        }

        function joinRoom() {
            if (!socket || !currentUser) { alert("ë¨¼ì € ì—°ê²°ë¶€í„° í•´ì£¼ì„¸ìš”."); return; }
            const payload = {
                code: roomCodeInput.value,
                userId: currentUser.userId,
                username: currentUser.username
            };
            log('send', `JOIN_ROOM: ${JSON.stringify(payload)}`);
            socket.emit('joinRoom', payload, (response) => {
                log('ack', `JOIN_ROOM response: ${JSON.stringify(response)}`);
            });
        }

        function leaveRoom() {
            if (!socket || !currentUser) { alert("ë¨¼ì € ì—°ê²°ë¶€í„° í•´ì£¼ì„¸ìš”."); return; }
            const payload = { code: roomCodeInput.value, userId: currentUser.userId };
            log('send', `LEAVE_ROOM: ${JSON.stringify(payload)}`);
            socket.emit('leaveRoom', payload, (response) => {
                log('ack', `LEAVE_ROOM response: ${JSON.stringify(response)}`);
                if (response.success) {
                  disconnectSocket();
                }
            });
        }

        // ì´ˆê¸° UI ìƒíƒœ ì„¤ì •
        updateUI();
    </script>
</body>
</html>