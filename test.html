<!DOCTYPE html>
<html lang="ko">
<head>
    <title>Full Feature Tester for NestJS</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-wrap: wrap; gap: 20px; padding: 20px; }
        .panel { border: 1px solid #ccc; padding: 15px; border-radius: 8px; background-color: #fff; }
        h2 { margin-top: 0; font-size: 1.1em; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        button { cursor: pointer; padding: 8px 12px; margin: 5px 0; border-radius: 4px; border: 1px solid #ccc; width: 100%; }
        button:disabled { cursor: not-allowed; background-color: #eee; color: #999; }
        .primary { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .danger { background-color: #dc3545; color: white; border-color: #dc3545; }
        input[type="text"] { padding: 8px; width: calc(100% - 18px); margin-bottom: 10px; }
        #consoleLog, #participantList { border: 1px solid #eee; background: #333; color: #eee; height: 450px; overflow-y: auto; padding: 10px; font-size: 13px; white-space: pre-wrap; font-family: monospace; }
        #participantList { height: 100px; }
        .log-send { color: #ff8df8; } .log-receive { color: #8dff8d; } .log-ack { color: #198754; font-style: italic; } .log-info { color: #80c7ff; } .log-error { color: #ff8d8d; }
    </style>
</head>
<body>
    <div class="panel">
        <h2>1. ì—°ê²°</h2>
        <input type="text" id="serverUrl" value="http://localhost:3000">
        <button class="primary" onclick="connectAsManager()" id="connectManagerBtn">ğŸ”‘ ê°œì„¤ìë¡œ ì—°ê²°</button>
        <button onclick="connectAsParticipant()" id="connectParticipantBtn">ğŸ‘¤ ì°¸ì—¬ìë¡œ ì—°ê²°</button>
        <button class="danger" onclick="disconnectSocket()" id="disconnectBtn" disabled>ğŸ”Œ ì—°ê²° ëŠê¸°</button>
        <p id="connectionStatus"><strong>ìƒíƒœ:</strong> ì—°ê²° ì•ˆë¨</p>
    </div>

    <div class="panel">
        <h2>2. ê°•ì˜ì‹¤/ì±„íŒ… ì•¡ì…˜</h2>
        <input type="text" id="roomCodeInput" value="ROOM101" placeholder="ë°© ì½”ë“œ">
        <button onclick="createRoom()" id="createBtn" disabled>ğŸ« ê°•ì˜ì‹¤ ìƒì„±</button>
        <button onclick="joinRoom()" id="joinBtn" disabled>ğŸšª ê°•ì˜ì‹¤ ì…ì¥</button>
        <hr>
        <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeydown="if(event.key==='Enter') sendChat()" disabled>
        <button onclick="sendChat()" id="chatBtn" disabled>ğŸ’¬ ì±„íŒ… ì „ì†¡</button>
        <hr>
        <button onclick="leaveRoom()" id="leaveBtn" disabled>ğŸš¶ ê°•ì˜ì‹¤ ë‚˜ê°€ê¸°</button>
    </div>

    <div class="panel">
        <h2>3. í™œë™ ì•¡ì…˜ (ê°œì„¤ì ì „ìš©)</h2>
        <input type="text" id="questIdInput" value="quest-uuid-001" placeholder="ë¬¸ì œ ID">
        <button onclick="selectProblem()" id="selectQuestBtn" disabled>ğŸ§© ë¬¸ì œ ì„ íƒ</button>
        <button onclick="startActivity()" id="startActivityBtn" disabled>â–¶ï¸ í™œë™ ì‹œì‘</button>
        <button onclick="requestFinalSubmission()" id="finalSubmitBtn" disabled>ğŸ ìµœì¢… ì œì¶œ ìš”ì²­</button>
        <button onclick="endActivity()" id="endActivityBtn" disabled>â¹ï¸ í™œë™ ì¢…ë£Œ</button>
    </div>
    
    <div class="panel">
        <h2>4. í™œë™ ì•¡ì…˜ (ì°¸ì—¬ì)</h2>
        <button onclick="submitSolution()" id="submitSolutionBtn" disabled>ğŸ™‹ í’€ì´ ì œì¶œ</button>
    </div>

    <div class="panel" style="width: 600px;">
        <h2>ì´ë²¤íŠ¸ ë¡œê·¸</h2>
        <div id="consoleLog"></div>
    </div>

    <div class="panel" style="width: 250px;">
        <h2>ì°¸ì—¬ì ëª©ë¡</h2>
        <div id="participantList"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // --- ìƒíƒœ ê´€ë¦¬ ë° UI ìš”ì†Œ ---
        let state = {
            socket: null,
            currentUser: null,
            currentRoom: null,
            participants: [],
            isManager: false,
            activityStarted: false,
        };

        const serverUrlInput = document.getElementById("serverUrl");
        const statusP = document.getElementById("connectionStatus");
        const logDiv = document.getElementById("consoleLog");
        const participantDiv = document.getElementById("participantList");
        const roomCodeInput = document.getElementById("roomCodeInput");
        const questIdInput = document.getElementById("questIdInput");
        const allButtons = document.querySelectorAll('button');
        const allInputs = document.querySelectorAll('input[type="text"]');

        // --- ì´ë²¤íŠ¸ ì´ë¦„ ê´€ë¦¬ ---
        const events = {
            // C -> S
            CREATE_ROOM: "createRoom",
            JOIN_ROOM: "joinRoom",
            LEAVE_ROOM: "leaveRoom",
            SEND_MESSAGE: "sendMessage",
            SELECT_PROBLEM_SET: "activity:problem-set-select", // ì„œë²„ì™€ ì´ë¦„ ì¼ì¹˜ í•„ìš”
            START_ACTIVITY: "activity:start",
            SUBMIT_SOLUTION: "activity:solution-submit",
            REQUEST_FINAL_SUBMISSION: "activity:final-submit",
            END_ACTIVITY: "activity:end",

            // S -> C
            USER_JOINED: "userJoined",
            USER_LEFT: "userLeft",
            CLASSROOM_DELETED: "classroomDeleted",
            MESSAGE: "message",
            ERROR: "error",
            PROBLEM_SELECTED_INFO: "problemSetSelected",
            ACTIVITY_BEGIN: "activityBegin",
            SOLUTION_SUBMITTED_BY_USER: "submitSolution", // ì„œë²„ì™€ ì´ë¦„ ì¼ì¹˜ í•„ìš”
            FINAL_SUBMISSIONS_DATA: "finalSubmissionsData",
            ACTIVITY_ENDED: "activityEnded",
        };

        // --- UI í•¨ìˆ˜ ---
        function log(type, message) {
            const logItem = document.createElement('div');
            logItem.className = `log-${type}`;
            logItem.textContent = `[${type.toUpperCase()}] ${new Date().toLocaleTimeString()} - ${message}`;
            logDiv.appendChild(logItem);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateParticipantList(participants = []) {
            state.participants = participants;
            participantDiv.innerHTML = `<h4>ì°¸ì—¬ì (${participants.length}ëª…)</h4>`;
            participants.forEach(p => {
                const pDiv = document.createElement('div');
                const isManager = state.currentRoom && p.userId === state.currentRoom.managerId ? ' (ë°©ì¥)' : '';
                pDiv.textContent = `${p.userName}${isManager}`;
                participantDiv.appendChild(pDiv);
            });
        }

        function updateUI() {
            const isConnected = state.socket && state.socket.connected;
            const inRoom = !!state.currentRoom;

            statusP.innerHTML = isConnected 
                ? `<strong>ìƒíƒœ:</strong> ì—°ê²°ë¨ (User: ${state.currentUser.userName})`
                : `<strong>ìƒíƒœ:</strong> ì—°ê²° ì•ˆë¨`;
            
            document.querySelectorAll('button').forEach(btn => {
                if (btn.id.startsWith('connect')) btn.disabled = isConnected;
                else if (btn.id === 'disconnectBtn') btn.disabled = !isConnected;
                else if (btn.id === 'createBtn' || btn.id === 'joinBtn') btn.disabled = !isConnected || inRoom;
                else if (btn.id === 'selectQuestBtn' || btn.id === 'startActivityBtn' || btn.id === 'finalSubmitBtn' || btn.id === 'endActivityBtn') btn.disabled = !inRoom || !state.isManager;
                else btn.disabled = !inRoom;
            });
            document.getElementById('chatInput').disabled = !inRoom;
        }
        
        // --- í…ŒìŠ¤íŠ¸ìš© ë°ì´í„° ìƒì„± ---
        function createUserData(isManager = false) {
            if (isManager) return { userId: 'manager-uuid-12345', userName: 'ë°©ì¥' };
            const randomId = Math.floor(1000 + Math.random() * 9000);
            return { userId: `participant-uuid-${randomId}`, userName: `ì°¸ì—¬ì-${randomId}` };
        }
        
        // --- ì†Œì¼“ ì—°ê²° ---
        function connectSocket(userData) {
            if (state.socket) return;
            state.currentUser = userData;
            
            log('info', `Connecting to ${serverUrlInput.value} as ${state.currentUser.userName}...`);
            state.socket = io(serverUrlInput.value);

            // --- ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ì—¬ê¸°ì— í•œ ë²ˆë§Œ ë“±ë¡ ---
            state.socket.on('connect', () => { log('info', `Socket connected with ID: ${state.socket.id}`); updateUI(); });
            state.socket.on('disconnect', (reason) => {
                log('info', `Socket disconnected. Reason: ${reason}`);
                Object.assign(state, { socket: null, currentUser: null, currentRoom: null, participants: [], isManager: false, activityStarted: false });
                updateUI();
            });
            state.socket.on(events.ERROR, (error) => log('error', `ERROR: ${JSON.stringify(error)}`));
            state.socket.on(events.USER_JOINED, (data) => { log('receive', `USER_JOINED: ${data.joinUser} ë‹˜ì´ ì…ì¥`); updateParticipantList(data.users); });
            state.socket.on(events.USER_LEFT, (data) => { log('receive', `USER_LEFT: ${data.leftUser} ë‹˜ì´ í‡´ì¥`); updateParticipantList(data.users); });
            state.socket.on(events.CLASSROOM_DELETED, (data) => { log('receive', `CLASSROOM_DELETED: ${data.message}`); alert(data.message); disconnectSocket(); });
            state.socket.on(events.MESSAGE, (data) => log('receive', `MESSAGE from ${data.userName}: ${data.message}`));
            state.socket.on('problemSetSelected', (data) => log('receive', `PROBLEM_SELECTED: ${data.questInfo.quest_description}`));
            state.socket.on(events.ACTIVITY_BEGIN, (data) => { log('receive', `ACTIVITY_BEGIN: íŒŒíŠ¸ ${data.myPartNumber} ë°°ì •ë¨`); state.activityStarted = true; updateUI(); });
            state.socket.on(events.SOLUTION_SUBMITTED_BY_USER, (data) => log('receive', `SUBMISSION: ${data.userName}ë‹˜ì´ íŒŒíŠ¸ ${data.partNumber} ì œì¶œ`));
            state.socket.on(events.FINAL_SUBMISSIONS_DATA, (data) => log('receive', `FINAL_SUBMISSIONS_DATA: ${Object.keys(data.finalSubmissions).length}ê°œì˜ ì œì¶œë¬¼ ê³µìœ ë¨`));
            state.socket.on(events.ACTIVITY_ENDED, (data) => { log('receive', `ACTIVITY_ENDED: ${data.message}`); state.activityStarted = false; updateUI(); });
        }
        
        function connectAsManager() { connectSocket(createUserData(true)); }
        function connectAsParticipant() { connectSocket(createUserData(false)); }
        function disconnectSocket() { if (state.socket) state.socket.disconnect(); }

        // --- ì•¡ì…˜ í•¨ìˆ˜ë“¤ ---
        function createRoom() {
            if (!state.socket) return;
            const payload = {
                id: `cls-${Date.now()}`, name: `${state.currentUser.userName}ì˜ ë°©`, code: roomCodeInput.value,
                managerId: state.currentUser.userId, managerName: state.currentUser.userName
            };
            log('send', `createRoom: ${JSON.stringify(payload)}`);
            state.socket.emit('createRoom', payload, (res) => {
                log('ack', `createRoom response: ${JSON.stringify(res)}`);
                if (res.success) { state.currentRoom = res.classroom; state.isManager = res.isManager; updateParticipantList(res.users); updateUI(); }
            });
        }

        function joinRoom() {
            if (!state.socket) return;
            const payload = { code: roomCodeInput.value, userId: state.currentUser.userId, userName: state.currentUser.userName };
            log('send', `joinRoom: ${JSON.stringify(payload)}`);
            state.socket.emit('joinRoom', payload, (res) => {
                log('ack', `joinRoom response: ${JSON.stringify(res)}`);
                if (res.success) { state.currentRoom = res.classroom; state.isManager = res.isManager; updateParticipantList(res.users); updateUI(); }
            });
        }
        
        function sendChat() {
            if (!state.socket || !state.currentRoom) return;
            const payload = { roomCode: state.currentRoom.code, userId: state.currentUser.userId, userName: state.currentUser.userName, message: document.getElementById('chatInput').value || `...` };
            log('send', `sendMessage: ${JSON.stringify(payload)}`);
            state.socket.emit('sendMessage', payload, (res) => log('ack', `sendMessage response: ${JSON.stringify(res)}`));
            document.getElementById('chatInput').value = '';
        }

        function leaveRoom() {
            if (!state.socket || !state.currentRoom) return;
            const payload = { code: state.currentRoom.code, userId: state.currentUser.userId };
            log('send', `leaveRoom: ${JSON.stringify(payload)}`);
            state.socket.emit('leaveRoom', payload, (res) => {
                log('ack', `leaveRoom response: ${JSON.stringify(res)}`);
                if (res.success) disconnectSocket();
            });
        }

        // --- í™œë™ ì•¡ì…˜ í•¨ìˆ˜ë“¤ ---
        function selectProblem() {
            if (!state.socket || !state.currentRoom) return;
            const payload = { roomCode: state.currentRoom.code, questId: questIdInput.value };
            log('send', `activity:problem-set-select: ${JSON.stringify(payload)}`);
            state.socket.emit('activity:problem-set-select', payload, (res) => log('ack', `activity:problem-set-select response: ${JSON.stringify(res)}`));
        }

        function startActivity() {
            if (!state.socket || !state.currentRoom) return;
            const payload = { roomCode: state.currentRoom.code };
            log('send', `activity:start: ${JSON.stringify(payload)}`);
            state.socket.emit('activity:start', payload, (res) => log('ack', `activity:start response: ${JSON.stringify(res)}`));
        }

        function submitSolution() {
            if (!state.socket || !state.currentRoom) return;
            const payload = { submissionContent: { myAnswer: `ë¸”ë¡í´ë¦¬ ê²°ê³¼ë¬¼ ${Math.random()}` } };
            log('send', `activity:solution-submit: ${JSON.stringify(payload)}`);
            state.socket.emit('activity:solution-submit', payload, (res) => log('ack', `activity:solution-submit response: ${JSON.stringify(res)}`));
        }

        function requestFinalSubmission() {
            if (!state.socket || !state.currentRoom) return;
            const payload = { roomCode: state.currentRoom.code };
            log('send', `activity:final-submit: ${JSON.stringify(payload)}`);
            state.socket.emit('activity:final-submit', payload, (res) => log('ack', `activity:final-submit response: ${JSON.stringify(res)}`));
        }

        function endActivity() {
            if (!state.socket || !state.currentRoom) return;
            const payload = { roomCode: state.currentRoom.code };
            log('send', `activity:end: ${JSON.stringify(payload)}`);
            state.socket.emit('activity:end', payload, (res) => log('ack', `activity:end response: ${JSON.stringify(res)}`));
        }
        
        // ì´ˆê¸° UI ìƒíƒœ ì„¤ì •
        updateUI();
    </script>
</body>
</html>