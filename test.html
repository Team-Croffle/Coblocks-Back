<!DOCTYPE html>
<html>
<head>
    <title>Socket.IO Tester</title>
</head>
<body>
    <h1>NestJS Socket Server Test</h1>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // ğŸ”¥ ì‹¤ì œ ì‹œë‚˜ë¦¬ì˜¤: í‰ìƒì‹œì—” ì†Œì¼“ ì—°ê²° ì•ˆí•¨, ê°•ì˜ì‹¤ ìƒì„±/ì…ì¥ì‹œì—ë§Œ ì—°ê²°
        let socket = null; // ì´ˆê¸°ì—” ì—°ê²° ì•ˆë¨
        let isConnected = false;

        //ê°•ì˜ì‹¤ ìƒì„± DTO
        const classroomDetails = {
            id: "519a2fbd-b1cd-494b-842b-3f2d1f19cf22",
            name: "testRoom1",
            code: "ABCD1234",
            managerId: "4d3fb42a-1507-4f6a-86d8-899732e4fbc5", //UUID
            managername: "testManager",
        };
        
        // ê°•ì˜ì‹¤ ì ‘ì† DTO
        const joinRoomInfo = {
            code: classroomDetails.code,
            userId: "4d3fb42a-1507-4f6a-86d8-899732e4fbc6", //UUID
            username: "joinUser",
        }

        // ğŸ“¡ ì†Œì¼“ ì—°ê²° í•¨ìˆ˜ (ê°•ì˜ì‹¤ ì§„ì…ì‹œì—ë§Œ í˜¸ì¶œ)
        function connectSocket() {
            if (!socket || !isConnected) {
                console.log("ğŸ”Œ ì†Œì¼“ ì—°ê²° ì‹œì‘...");
                socket = io("http://localhost:3000");
                
                socket.on('connect', () => {
                    isConnected = true;
                    console.log("âœ… ì†Œì¼“ ì—°ê²° ì„±ê³µ:", socket.id);
                    document.getElementById("connectionStatus").innerText = `ì—°ê²° ìƒíƒœ: ì—°ê²°ë¨ (${socket.id})`;
                });

                socket.on('disconnect', () => {
                    isConnected = false;
                    console.log("âŒ ì†Œì¼“ ì—°ê²° í•´ì œ");
                    document.getElementById("connectionStatus").innerText = "ì—°ê²° ìƒíƒœ: ì—°ê²° í•´ì œë¨";
                });

                // ğŸ“¨ ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìˆ˜ì‹  (ë‹¤ë¥¸ ì‚¬ìš©ì ì…ì¥ ì•Œë¦¼)
                socket.on('userJoined', (data, participants, state) => {
                    console.log("ğŸ‘¥ ìƒˆ ì‚¬ìš©ì ì…ì¥:", data, participants, state);
                    document.getElementById("resultChat").innerHTML += 
                        `<div>ğŸ”” ${data.message} (ì°¸ê°€ì ìˆ˜: ${participants?.length || 0})</div>`;
                });

                // ğŸ“¨ ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ì‹ 
                socket.on('newMessage', (data) => {
                    console.log("ğŸ’¬ ìƒˆ ë©”ì‹œì§€:", data);
                    document.getElementById("resultChat").innerHTML += 
                        `<div>ğŸ’¬ ${data.username}: ${data.message}</div>`;
                });
            }
        }

        // ğŸ« ê°•ì˜ì‹¤ ìƒì„± (ì†Œì¼“ ì—°ê²° + ë°© ìƒì„±)
        function createClassroom() {
            connectSocket(); // ì†Œì¼“ ì—°ê²°
            
            setTimeout(() => { // ì—°ê²° ì™„ë£Œ ëŒ€ê¸°
                if (isConnected) {
                    socket.emit("createRoom", classroomDetails, (response) => {
                        console.log("ğŸ« ê°•ì˜ì‹¤ ìƒì„± ì‘ë‹µ:", response);
                        document.getElementById("resultJoinClassroom").innerHTML = 
                            `<strong>ê°•ì˜ì‹¤ ìƒì„± ê²°ê³¼:</strong> ${response.message}<br>
                             ì°¸ê°€ì ìˆ˜: ${response.participants?.length || 0}<br>
                             ë§¤ë‹ˆì € ì—¬ë¶€: ${response.isManager ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}<br>
                             ë°© ìƒíƒœ: ${response.state || 'unknown'}`;
                    });
                } else {
                    console.log("âŒ ì†Œì¼“ ì—°ê²° ëŒ€ê¸° ì¤‘...");
                }
            }, 1000);
        }

        // ğŸšª ê°•ì˜ì‹¤ ì…ì¥ (ì†Œì¼“ ì—°ê²° + ë°© ì…ì¥)
        function enterClassroom() {
            connectSocket(); // ì†Œì¼“ ì—°ê²°
            
            setTimeout(() => { // ì—°ê²° ì™„ë£Œ ëŒ€ê¸°
                if (isConnected) {
                    socket.emit("joinRoom", joinRoomInfo, (response) => {
                        console.log("ğŸšª ê°•ì˜ì‹¤ ì…ì¥ ì‘ë‹µ:", response);
                        document.getElementById("resultClassroom").innerHTML = 
                            `<strong>ê°•ì˜ì‹¤ ì…ì¥ ê²°ê³¼:</strong> ${response.message}<br>
                             ë°© ì´ë¦„: ${response.roomName || 'N/A'}<br>
                             ë°© ì½”ë“œ: ${response.roomCode || 'N/A'}<br>
                             ì°¸ê°€ì ìˆ˜: ${response.roomParticipants?.length || 0}<br>
                             ë§¤ë‹ˆì € ì—¬ë¶€: ${response.roomIsManager ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}<br>
                             ë°© ìƒíƒœ: ${response.roomState || 'unknown'}`;
                    });
                } else {
                    console.log("âŒ ì†Œì¼“ ì—°ê²° ëŒ€ê¸° ì¤‘...");
                }
            }, 1000);
        }

        // ğŸ’¬ ì±„íŒ… ì „ì†¡ í…ŒìŠ¤íŠ¸
        function sendChat() {
            if (isConnected && socket) {
                const chatData = {
                    code: classroomDetails.code,
                    userId: joinRoomInfo.userId,
                    username: joinRoomInfo.username,
                    message: `í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ${new Date().getTime()}`
                };
                
                socket.emit("sendMessage", chatData, (response) => {
                    console.log("ğŸ’¬ ì±„íŒ… ì „ì†¡ ì‘ë‹µ:", response);
                    if (response.success) {
                        document.getElementById("resultChat").innerHTML += 
                            `<div>âœ… ë‚´ ë©”ì‹œì§€: ${chatData.message}</div>`;
                    }
                });
            } else {
                alert("ë¨¼ì € ê°•ì˜ì‹¤ì— ì…ì¥í•˜ì„¸ìš”!");
            }
        }

        // ğŸšª ê°•ì˜ì‹¤ ë‚˜ê°€ê¸° (ì†Œì¼“ ì—°ê²° í•´ì œ)
        function leaveClassroom() {
            if (socket && isConnected) {
                console.log("ğŸšª ê°•ì˜ì‹¤ ë‚˜ê°€ê¸°...");
                socket.emit('leaveRoom', {code: classroomDetails.code, userId: joinRoomInfo.userId }, (response) => {
                    console.log("ğŸšª ê°•ì˜ì‹¤ ë‚˜ê°€ê¸° ì‘ë‹µ:", response);
                    document.getElementById("resultClassroom").innerHTML = 
                        `<strong>ê°•ì˜ì‹¤ ë‚˜ê°€ê¸° ê²°ê³¼:</strong> ${response.message}`;
                    
                    // ì„œë²„ ì‘ë‹µì„ ë°›ì€ í›„ì— ì†Œì¼“ ì—°ê²° í•´ì œ
                    socket.disconnect();
                    socket = null;
                    isConnected = false;
                    document.getElementById("connectionStatus").innerText = "ì—°ê²° ìƒíƒœ: ì—°ê²° í•´ì œë¨";
                });
            } else {
                alert("í˜„ì¬ ê°•ì˜ì‹¤ì— ì…ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }
        }

    </script>

    <p> Socket.IO í´ë¼ì´ì–¸íŠ¸ í…ŒìŠ¤íŠ¸ </p>
    <p id="connectionStatus">ì—°ê²° ìƒíƒœ: ì—°ê²° ì•ˆë¨ (í‰ìƒì‹œ ìƒíƒœ)</p>
    <br>
    <p id="resultJoinClassroom">ê°•ì˜ì‹¤ ìƒì„± ê²°ê³¼ê°€ ë‚˜ì˜¬ ê³µê°„</p>
    <p id="resultClassroom">ê°•ì˜ì‹¤ ì…ì¥ ê²°ê³¼ê°€ ë‚˜ì˜¬ ê³µê°„</p>
    <div id="resultChat" style="border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; background: #f9f9f9;">
        <div>ğŸ’¬ ì±„íŒ…ì°½ (ì‹¤ì‹œê°„ ë©”ì‹œì§€ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤)</div>
    </div>
    <br>
    <button id="getClassroomInfo" onclick="getClassroomInfo()">ê°•ì˜ì‹¤ ì •ë³´ í™•ì¸í•˜ê¸°</button>
    <button id="createClassroom" onclick="createClassroom()">ğŸ« ê°•ì˜ì‹¤ ìƒì„± (ì†Œì¼“ ì—°ê²°)</button>
    <br><br>
    <button id="enterClassroom" onclick="enterClassroom()">ğŸšª ê°•ì˜ì‹¤ ì…ì¥ (ì†Œì¼“ ì—°ê²°)</button>
    <br><br>
    <button id="sendChat" onclick="sendChat()">ğŸ’¬ ì±„íŒ… ì „ì†¡</button>
    <br><br>
    <button id="leaveClassroom" onclick="leaveClassroom()">ğŸšª ê°•ì˜ì‹¤ ë‚˜ê°€ê¸° (ì†Œì¼“ í•´ì œ)</button>
</body>
</html>